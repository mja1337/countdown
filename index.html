<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meeting Countdown</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0f1b3a;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --accent:#7c5cff;
      --accent2:#27e8a7;
      --danger:#ff3d71;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(39,232,167,.25), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
    }

    .card{
      background:linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    h1{
      font-size: clamp(20px, 3vw, 28px);
      margin:0 0 6px 0;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }

    .clock{
      font-family: var(--mono);
      font-size: clamp(46px, 7vw, 84px);
      letter-spacing: 1.5px;
      display:flex;
      align-items:baseline;
      justify-content:center;
      padding:18px 14px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      margin-top:16px;
      user-select:none;
      text-align:center;
      line-height:1.05;
    }
    .clock small{
      font-family:var(--sans);
      font-size:14px;
      color:var(--muted);
      margin-left:12px;
      letter-spacing:0;
      display:inline-block;
      vertical-align:baseline;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:14px;
    }

    .field{
      grid-column: span 12;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    label{
      font-size:13px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input, button{
      font: inherit;
      color: var(--text);
    }

    input{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      transition: border .15s ease, transform .15s ease, background .15s ease;
      min-width: 260px;
    }
    input:focus{
      border-color: rgba(124,92,255,.75);
      background: rgba(0,0,0,.32);
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    button{
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(124,92,255,.85), rgba(124,92,255,.55));
      padding:12px 14px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(124,92,255,.18);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      font-weight: 650;
      letter-spacing:.2px;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:active{ transform: translateY(0px); filter: brightness(.98); }

    button.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow:none;
      font-weight:600;
    }

    button.danger{
      background: linear-gradient(180deg, rgba(255,61,113,.85), rgba(255,61,113,.55));
      box-shadow: 0 10px 22px rgba(255,61,113,.16);
    }

    .meta{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }

    .flash{
      animation: flash 0.6s steps(2, end) infinite;
      border-color: rgba(255,61,113,.8) !important;
      box-shadow: 0 0 0 3px rgba(255,61,113,.18), var(--shadow);
    }
    @keyframes flash{
      0%{ opacity:1; }
      50%{ opacity:.15; }
      100%{ opacity:1; }
    }

    .hint{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }

    .warn{
      color: rgba(255,255,255,.85);
      background: rgba(255,61,113,.12);
      border: 1px solid rgba(255,61,113,.25);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 12px;
      display:none;
    }
    .warn.show{ display:block; }

    @media (min-width: 780px){
      .field.time { grid-column: span 8; }
      .field.actions { grid-column: span 4; }
      .btns{ justify-content:flex-start; height:100%; align-content:flex-end; }
      .clock{ margin-top:18px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <header>
        <div>
          <h1>Meeting Countdown</h1>
          <p class="sub">
            Set a meeting start + end (local time). The page counts down to the end, and suggests a 5-minute break at halfway.
          </p>
        </div>
        <div class="pill" id="nowPill">Now: --:--:--</div>
      </header>

      <div class="clock" id="display">00:00:00 <small id="status">Ready</small></div>

      <div class="grid">
        <div class="field time">
          <label>Meeting times</label>
          <div class="row">
            <input id="startAt" type="datetime-local" />
            <input id="endAt" type="datetime-local" />
            <button class="secondary" id="setDefaults" type="button">Now + 30m</button>
          </div>
        </div>

        <div class="field actions">
          <label>Actions</label>
          <div class="btns">
            <button id="start" type="button">Start</button>
            <button class="secondary" id="pause" type="button">Pause</button>
            <button class="danger" id="reset" type="button">Reset</button>
          </div>
        </div>
      </div>

      <div class="warn" id="warn"></div>

      <div class="meta">
        <div class="pill" id="meetingPill">Meeting: —</div>
        <div class="pill" id="breakPill">Break: —</div>
        <div class="pill" id="modePill">Mode: Not running</div>
      </div>

      <p class="hint">
        Notes: Break is scheduled at the halfway point (50% of total meeting length) and lasts 5 minutes.
        If the meeting hasn’t started yet, the big timer counts down to the start. Once started, it counts down to the end.
      </p>
    </section>
  </main>

  <script>
    const el = (id) => document.getElementById(id);

    const startAtInput = el("startAt");
    const endAtInput = el("endAt");
    const setDefaultsBtn = el("setDefaults");

    const startBtn = el("start");
    const pauseBtn = el("pause");
    const resetBtn = el("reset");

    const display = el("display");
    const status = el("status");
    const nowPill = el("nowPill");
    const meetingPill = el("meetingPill");
    const breakPill = el("breakPill");
    const modePill = el("modePill");
    const warnBox = el("warn");

    const STORAGE_KEY = "meeting-countdown:v1";

    let timerId = null;

    let meetingStart = null;
    let meetingEnd = null;
    let breakStart = null;
    let breakEnd = null;

    let paused = false;
    let remainingWhenPausedMs = null;
    let pausedMode = null; // "pre" | "meeting"

    // --- Helpers ---
    const pad2 = (n) => String(n).padStart(2, "0");

    function formatHMS(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }

    function setDisplay(text, flash=false) {
      // Keep the "small" status node stable by rewriting only the text nodes:
      display.childNodes[0].nodeValue = text + " ";
      display.classList.toggle("flash", flash);
    }

    function toLocalDateTimeValue(d) {
      // datetime-local wants: YYYY-MM-DDTHH:MM (no seconds)
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function prettyTime(d) {
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function prettyDateTime(d) {
      return d.toLocaleString([], {
        weekday: "short",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function showWarn(msg) {
      warnBox.textContent = msg;
      warnBox.classList.add("show");
    }
    function clearWarn() {
      warnBox.textContent = "";
      warnBox.classList.remove("show");
    }

    function parseInputs() {
      clearWarn();

      const s = startAtInput.value ? new Date(startAtInput.value) : null;
      const e = endAtInput.value ? new Date(endAtInput.value) : null;

      if (!s || Number.isNaN(s.getTime())) {
        showWarn("Start time is missing/invalid.");
        return null;
      }
      if (!e || Number.isNaN(e.getTime())) {
        showWarn("End time is missing/invalid.");
        return null;
      }
      if (e.getTime() <= s.getTime()) {
        showWarn("End time must be after start time.");
        return null;
      }

      return { s, e };
    }

    function computeBreakWindow(s, e) {
      const durationMs = e.getTime() - s.getTime();
      const halfMs = Math.floor(durationMs / 2);
      const bStart = new Date(s.getTime() + halfMs);
      const bEnd = new Date(bStart.getTime() + 5 * 60 * 1000); // 5 minutes
      return { bStart, bEnd };
    }

    function saveState() {
      if (!meetingStart || !meetingEnd) return;
      const payload = {
        start: meetingStart.toISOString(),
        end: meetingEnd.toISOString()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed?.start || !parsed?.end) return false;

        const s = new Date(parsed.start);
        const e = new Date(parsed.end);
        if (Number.isNaN(s.getTime()) || Number.isNaN(e.getTime())) return false;

        startAtInput.value = toLocalDateTimeValue(s);
        endAtInput.value = toLocalDateTimeValue(e);
        return true;
      } catch {
        return false;
      }
    }

    // --- Live "Now" pill ---
    setInterval(() => {
      nowPill.textContent = "Now: " + prettyTime(new Date());
    }, 250);

    function refreshMeta() {
      if (!meetingStart || !meetingEnd) {
        meetingPill.textContent = "Meeting: —";
        breakPill.textContent = "Break: —";
        return;
      }

      meetingPill.textContent = `Meeting: ${prettyDateTime(meetingStart)} → ${prettyDateTime(meetingEnd)}`;

      const b = computeBreakWindow(meetingStart, meetingEnd);
      breakStart = b.bStart;
      breakEnd = b.bEnd;

      breakPill.textContent = `Break: ${prettyTime(breakStart)}–${prettyTime(breakEnd)} (5m)`;
    }

    // --- Core loop ---
    function tick() {
      if (!meetingStart || !meetingEnd) return;

      const now = new Date();

      // Determine phase
      const preMeeting = now.getTime() < meetingStart.getTime();
      const inMeeting = now.getTime() >= meetingStart.getTime() && now.getTime() < meetingEnd.getTime();
      const finished = now.getTime() >= meetingEnd.getTime();

      // Break window (computed from fixed start/end)
      const b = computeBreakWindow(meetingStart, meetingEnd);
      breakStart = b.bStart;
      breakEnd = b.bEnd;

      // Flash logic: 30s before break starts, or during break
      const msToBreak = breakStart.getTime() - now.getTime();
      const inBreak = now.getTime() >= breakStart.getTime() && now.getTime() < breakEnd.getTime();
      const flash = (msToBreak > 0 && msToBreak <= 30_000) || inBreak;

      if (finished) {
        setDisplay("00:00:00", true);
        status.textContent = "Done";
        modePill.textContent = "Mode: Finished";
        stopTimer(false);
        return;
      }

      if (preMeeting) {
        const msToStart = meetingStart.getTime() - now.getTime();
        setDisplay(formatHMS(msToStart), flash);
        status.textContent = "Until start";
        modePill.textContent = "Mode: Waiting to start";

        // Break info still useful even before start: show exact time + countdown
        breakPill.textContent =
          `Break: ${prettyTime(breakStart)}–${prettyTime(breakEnd)} (in ${formatHMS(msToBreak)})`;
        return;
      }

      // In meeting
      const msToEnd = meetingEnd.getTime() - now.getTime();
      setDisplay(formatHMS(msToEnd), flash);
      status.textContent = inBreak ? "On break" : "Until end";
      modePill.textContent = inBreak ? "Mode: Break (5m)" : "Mode: Running";

      if (inBreak) {
        const msToBreakEnd = breakEnd.getTime() - now.getTime();
        breakPill.textContent =
          `Break: NOW (ends in ${formatHMS(msToBreakEnd)})`;
      } else if (now.getTime() < breakStart.getTime()) {
        breakPill.textContent =
          `Break: ${prettyTime(breakStart)}–${prettyTime(breakEnd)} (in ${formatHMS(msToBreak)})`;
      } else {
        breakPill.textContent =
          `Break: done (${prettyTime(breakStart)}–${prettyTime(breakEnd)})`;
      }
    }

    function startTimer() {
      // Resume path
      if (paused && remainingWhenPausedMs != null && pausedMode) {
        const now = Date.now();

        if (pausedMode === "pre") {
          meetingStart = new Date(now + remainingWhenPausedMs);
          // Keep original duration from inputs (or existing)
          const parsed = parseInputs();
          const durationMs = parsed
            ? (parsed.e.getTime() - parsed.s.getTime())
            : (meetingEnd ? meetingEnd.getTime() - meetingStart.getTime() : 30 * 60 * 1000);

          meetingEnd = new Date(meetingStart.getTime() + durationMs);
        } else {
          // paused during meeting => keep meetingStart fixed, push meetingEnd out by remaining
          meetingEnd = new Date(now + remainingWhenPausedMs);
          // meetingStart should already exist; if not, fall back to inputs
          if (!meetingStart) {
            const parsed = parseInputs();
            meetingStart = parsed ? parsed.s : new Date(now);
          }
        }

        paused = false;
        remainingWhenPausedMs = null;
        pausedMode = null;
      } else {
        const parsed = parseInputs();
        if (!parsed) return;

        meetingStart = parsed.s;
        meetingEnd = parsed.e;
      }

      refreshMeta();
      saveState();

      display.classList.remove("flash");
      stopTimer(false);
      tick();
      timerId = setInterval(tick, 200);
    }

    function stopTimer(resetModeText=true) {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      if (resetModeText) modePill.textContent = "Mode: Not running";
    }

    function pauseTimer() {
      if (!timerId || !meetingStart || !meetingEnd) return;

      const now = Date.now();

      if (now < meetingStart.getTime()) {
        remainingWhenPausedMs = meetingStart.getTime() - now;
        pausedMode = "pre";
      } else {
        remainingWhenPausedMs = Math.max(0, meetingEnd.getTime() - now);
        pausedMode = "meeting";
      }

      paused = true;
      stopTimer(false);

      status.textContent = "Paused";
      modePill.textContent = "Mode: Paused";
      setDisplay(formatHMS(remainingWhenPausedMs), false);
    }

    function resetAll() {
      stopTimer(true);
      meetingStart = null;
      meetingEnd = null;
      breakStart = null;
      breakEnd = null;

      paused = false;
      remainingWhenPausedMs = null;
      pausedMode = null;

      display.classList.remove("flash");
      setDisplay("00:00:00", false);
      status.textContent = "Ready";
      meetingPill.textContent = "Meeting: —";
      breakPill.textContent = "Break: —";
      clearWarn();
    }

    function setDefaultsNowPlus30() {
      const now = new Date();
      const end = new Date(now.getTime() + 30 * 60 * 1000);
      startAtInput.value = toLocalDateTimeValue(now);
      endAtInput.value = toLocalDateTimeValue(end);

      // If already running or paused, restart cleanly
      if (timerId || paused) {
        paused = false;
        remainingWhenPausedMs = null;
        pausedMode = null;
        startTimer();
      }
    }

    // --- UI wiring ---
    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    resetBtn.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      resetAll();
    });

    setDefaultsBtn.addEventListener("click", setDefaultsNowPlus30);

    // Make Enter start the timer when editing fields
    [startAtInput, endAtInput].forEach((node) => {
      node.addEventListener("keydown", (e) => {
        if (e.key === "Enter") startTimer();
      });
    });

    // Initialize
    nowPill.textContent = "Now: " + prettyTime(new Date());

    // Load previous times if present, otherwise set defaults
    if (!loadState()) {
      setDefaultsNowPlus30();
    }
    resetAll();
    // Keep the inputs (loaded/default), but don’t auto-start.
  </script>
</body>
</html>
